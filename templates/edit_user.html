{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Edit User</h1>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="post" action="{{ url_for('edit_user', user_id=user.id) }}" x-data="editUserForm()" @submit.prevent="submitForm" enctype="multipart/form-data">
            <div class="mb-6 text-center">
                <div class="mb-4">
                    <img :src="previewUrl || '{{ user.get_profile_pic_url() }}'" alt="{{ user.name }}"
                         class="w-32 h-32 object-cover rounded-full mx-auto border-4 border-blue-500">
                </div>

                <div class="mb-4">
                    <label for="profile_pic" class="block text-gray-700 mb-2">Update Profile Picture</label>
                    <input type="file" id="profile_pic" name="profile_pic" accept="image/*"
                           @change="previewImage"
                           class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                </div>
            </div>

            <div class="mb-4">
                <label for="name" class="block text-gray-700 mb-2">Full Name</label>
                <input type="text" id="name" name="name" value="{{ user.name }}" required
                       class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="mb-4">
                <label for="email" class="block text-gray-700 mb-2">Email</label>
                <input type="email" id="email" name="email" value="{{ user.email }}" required
                       class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="mb-4">
                <label for="custom_data" class="block text-gray-700 mb-2">Additional Information</label>
                <textarea id="custom_data" name="custom_data" rows="3"
                          class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">{{ user.custom_data }}</textarea>
            </div>

            <div class="mb-4">
                <label for="user_type" class="block text-gray-700 mb-2">User Type</label>
                <select id="user_type" name="user_type"
                        class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="student" {% if not user.is_admin %}selected{% endif %}>Student</option>
                    <option value="admin" {% if user.is_admin %}selected{% endif %}>Administrator</option>
                </select>
            </div>

            <div class="flex justify-between">
                <a
                    href="{{ url_for('admin') }}"
                    class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded inline-block text-center"
                    :class="{'opacity-50 pointer-events-none': isSubmitting}"
                >
                    Cancel
                </a>
                <button
                    type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center min-w-[120px]"
                    :disabled="isSubmitting"
                >
                    <template x-if="isSubmitting">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <span x-text="isSubmitting ? 'Updating...' : 'Update User'"></span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function editUserForm() {
        return {
            isSubmitting: false,
            previewUrl: null,
            init() {
                // Show welcome toast when page loads
                setTimeout(() => {
                    Alpine.evaluate(document.body, '$data.add("Editing user: {{ user.name }}", "info", 3000)');
                }, 500);
            },
            previewImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.previewUrl = URL.createObjectURL(file);

                // Show toast notification for image selection
                Alpine.evaluate(document.body, '$data.add("Profile picture selected. Click Update User to save changes.", "info", 3000)');
            },
            submitForm() {
                this.isSubmitting = true;
                const form = this.$el;
                const formData = new FormData(form);

                // Add headers to identify AJAX requests
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                };

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: headers
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success toast
                        Alpine.evaluate(document.body, '$data.add("User updated successfully!", "success", 3000)');

                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = '{{ url_for('admin') }}';
                        }, 1000);
                    } else {
                        // Show error toast
                        const errorMessage = data.message || 'Failed to update user';
                        Alpine.evaluate(document.body, `$data.add("${errorMessage}", "error", 5000)`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    // Show error toast
                    Alpine.evaluate(document.body, '$data.add("An error occurred while updating the user.", "error", 5000)');
                })
                .finally(() => {
                    this.isSubmitting = false;
                });
            }
        };
    }
</script>
{% endblock %}
