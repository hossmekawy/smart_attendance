{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto" x-data="editProfileForm()">
    <h1 class="text-3xl font-bold mb-6">Edit Profile</h1>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form action="{{ url_for('auth.edit_profile') }}" method="POST" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold mb-4">Profile Picture</h2>

                    <div class="mb-4 text-center">
                        <img :src="previewUrl || '{{ current_user.get_profile_pic_url() }}'" alt="{{ current_user.name }}"
                             class="w-40 h-40 object-cover rounded-full mx-auto border-4 border-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="profile_pic" class="block text-gray-700 font-semibold mb-2">Update Profile Picture</label>
                        <input type="file" id="profile_pic" name="profile_pic" accept="image/*"
                               @change="previewImage"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">Update Face Data</h3>
                        <div class="relative">
                            <video x-ref="video" class="w-full rounded border" autoplay playsinline></video>
                            <canvas x-ref="canvas" style="display: none;"></canvas>

                            <div x-show="processingImage" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded">
                                <div class="text-white text-center">
                                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    <p class="mt-2">Processing...</p>
                                </div>
                            </div>
                        </div>

                        <button type="button" @click="captureFace"
                                class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold"
                                :disabled="processingImage">
                            <i class="fas fa-camera mr-2"></i>Capture New Face Data
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-4">Personal Information</h2>

                    <div class="mb-4">
                        <label for="name" class="block text-gray-700 font-semibold mb-2">Full Name</label>
                        <input type="text" id="name" name="name" value="{{ current_user.name }}" required
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="email" value="{{ current_user.email }}" disabled
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100">
                        <p class="mt-1 text-sm text-gray-500">Email cannot be changed</p>
                    </div>

                    <div class="mb-4">
                        <label for="custom_data" class="block text-gray-700 font-semibold mb-2">Additional Information</label>
                        <textarea id="custom_data" name="custom_data" rows="4"
                                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">{{ current_user.custom_data }}</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="current_password" class="block text-gray-700 font-semibold mb-2">Current Password (required to change password)</label>
                        <input type="password" id="current_password" name="current_password"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="new_password" class="block text-gray-700 font-semibold mb-2">New Password (leave blank to keep current)</label>
                        <input type="password" id="new_password" name="new_password"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <a href="{{ url_for('auth.profile') }}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                    Cancel
                </a>
                <button type="submit" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function editProfileForm() {
        return {
            previewUrl: null,
            processingImage: false,

            init() {
                this.startCamera();
            },

            startCamera() {
                const video = this.$refs.video;

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(stream => {
                            video.srcObject = stream;
                        })
                        .catch(err => {
                            console.error("Error accessing the camera: ", err);
                        });
                }
            },

            previewImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.previewUrl = URL.createObjectURL(file);
            },

            captureFace() {
                const video = this.$refs.video;
                const canvas = this.$refs.canvas;

                if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }

                this.processingImage = true;

                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw the video frame to the canvas
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert canvas to blob and send to server
                canvas.toBlob(blob => {
                    const formData = new FormData();
                    formData.append('image', blob, 'face.jpg');
                    formData.append('face_update', 'true');

                    fetch('{{ url_for("auth.edit_profile") }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.processingImage = false;

                        if (data.success) {
                            // Use Alpine.js toast instead of alert
                            Alpine.evaluate(document.body, '$data.add("Face data updated successfully!", "success", 5000)');
                        } else {
                            // Use Alpine.js toast for error
                            Alpine.evaluate(document.body, `$data.add("${data.message || 'Failed to update face data. Please try again.'}", "error", 5000)`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.processingImage = false;
                        // Use Alpine.js toast for error
                        Alpine.evaluate(document.body, '$data.add("An error occurred while updating face data.", "error", 5000)');
                    });
                }, 'image/jpeg', 0.8);
            }
        }
    }
</script>
{% endblock %}
